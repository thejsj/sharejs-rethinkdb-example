!function(){function t(t){for(var e in t)return!0;return!1}!function(){var t={exports:{}},e=t.exports;e.name="text",e.uri="http://sharejs.org/types/textv1",e.create=function(t){if(null!=t&&"string"!=typeof t)throw Error("Initial data must be a string");return t||""};var n=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},i=function(t){if(!n(t))throw Error("Op must be an array of components");for(var e=null,i=0;t.length>i;i++){var o=t[i];switch(typeof o){case"object":if(!("number"==typeof o.d&&o.d>0))throw Error("Object components must be deletes of size > 0");break;case"string":if(!(o.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(o>0))throw Error("Skip components must be >0");if("number"==typeof e)throw Error("Adjacent skip components should be combined")}e=o}if("number"==typeof e)throw Error("Op has a trailing skip")},o=function(t){return function(e){return e&&0!==e.d?0===t.length?t.push(e):typeof e==typeof t[t.length-1]?"object"==typeof e?t[t.length-1].d+=e.d:t[t.length-1]+=e:t.push(e):void 0}},r=function(t){var e=0,n=0,i=function(i,o){if(e===t.length)return-1===i?null:i;var r,s=t[e];return"number"==typeof s?-1===i||i>=s-n?(r=s-n,++e,n=0,r):(n+=i,i):"string"==typeof s?-1===i||"i"===o||i>=s.length-n?(r=s.slice(n),++e,n=0,r):(r=s.slice(n,n+i),n+=i,r):-1===i||"d"===o||i>=s.d-n?(r={d:s.d-n},++e,n=0,r):(n+=i,{d:i})},o=function(){return t[e]};return[i,o]},s=function(t){return"number"==typeof t?t:t.length||t.d},a=function(t){return t.length>0&&"number"==typeof t[t.length-1]&&t.pop(),t};e.normalize=function(t){for(var e=[],n=o(e),i=0;t.length>i;i++)n(t[i]);return a(e)},e.apply=function(t,e){if("string"!=typeof t)throw Error("Snapshot should be a string");i(e);for(var n=[],o=0;e.length>o;o++){var r=e[o];switch(typeof r){case"number":if(r>t.length)throw Error("The op is too long for this document");n.push(t.slice(0,r)),t=t.slice(r);break;case"string":n.push(r);break;case"object":t=t.slice(r.d)}}return n.join("")+t},e.transform=function(t,e,n){if("left"!=n&&"right"!=n)throw Error("side ("+n+") must be 'left' or 'right'");i(t),i(e);for(var c=[],h=o(c),l=r(t),p=l[0],u=l[1],f=0;e.length>f;f++){var d,v,g=e[f];switch(typeof g){case"number":for(d=g;d>0;)v=p(d,"i"),h(v),"string"!=typeof v&&(d-=s(v));break;case"string":"left"===n&&"string"==typeof u()&&h(p(-1)),h(g.length);break;case"object":for(d=g.d;d>0;)switch(v=p(d,"i"),typeof v){case"number":d-=v;break;case"string":h(v);break;case"object":d-=v.d}}}for(;g=p(-1);)h(g);return a(c)},e.compose=function(t,e){i(t),i(e);for(var n=[],c=o(n),h=r(t)[0],l=0;e.length>l;l++){var p,u,f=e[l];switch(typeof f){case"number":for(p=f;p>0;)u=h(p,"d"),c(u),"object"!=typeof u&&(p-=s(u));break;case"string":c(f);break;case"object":for(p=f.d;p>0;)switch(u=h(p,"d"),typeof u){case"number":c({d:u}),p-=u;break;case"string":p-=u.length;break;case"object":c(u)}}}for(;f=h(-1);)c(f);return a(n)};var c=function(t,e){for(var n=0,i=0;e.length>i;i++){var o=e[i];if(n>=t)break;switch(typeof o){case"number":if(n+o>=t)return t;n+=o;break;case"string":n+=o.length,t+=o.length;break;case"object":t-=Math.min(o.d,t-n)}}return t};e.transformSelection=function(t,e,n){var i=0;if(n){for(var o=0;e.length>o;o++){var r=e[o];switch(typeof r){case"number":i+=r;break;case"string":i+=r.length}}return i}return"number"==typeof t?c(t,e):[c(t[0],e),c(t[1],e)]},e.transformCursor=e.transformSelection,e.selectionEq=function(t,e){return null!=t[0]&&t[0]===t[1]&&(t=t[0]),null!=e[0]&&e[0]===e[1]&&(e=e[0]),t===e||null!=t[0]&&null!=e[0]&&t[0]===e[0]&&t[1]==e[1]};var h=window.ottypes=window.ottypes||{},l=t.exports;h[l.name]=l,l.uri&&(h[l.uri]=l)}();var e="undefined"!=typeof require?require("ottypes"):window.ottypes;e["http://sharejs.org/types/textv1"].api={provides:{text:!0},getLength:function(){return this.getSnapshot().length},get:function(){return this.getSnapshot()},getText:function(){return console.warn("`getText()` is deprecated; use `get()` instead."),this.get()},insert:function(t,e,n){return this.submitOp([t,e],n)},remove:function(t,e,n){return this.submitOp([t,{d:e}],n)},_onOp:function(t){for(var e=0,n=0,i=0;i<t.length;i++){var o=t[i];switch(typeof o){case"number":e+=o,n+=o;break;case"string":this.onInsert&&this.onInsert(e,o),e+=o.length;break;case"object":this.onRemove&&this.onRemove(e,o.d),n+=o.d}}}},!function(){function t(t){t.t="text0";var e={p:t.p.pop()};null!=t.si&&(e.i=t.si),null!=t.sd&&(e.d=t.sd),t.o=[e]}function e(t){t.p.push(t.o[0].p),null!=t.o[0].i&&(t.si=t.o[0].i),null!=t.o[0].d&&(t.sd=t.o[0].d),delete t.t,delete t.o}var n={exports:{}},i=n.exports;i._bootstrapTransform=function(t,e,n,i){var o=function(t,n,i,o){e(i,t,n,"left"),e(o,n,t,"right")},r=t.transformX=function(t,e){n(t),n(e);for(var s=[],a=0;a<e.length;a++){for(var c=e[a],h=[],l=0;l<t.length;){var p=[];if(o(t[l],c,h,p),l++,1!==p.length){if(0===p.length){for(var u=l;u<t.length;u++)i(h,t[u]);c=null;break}for(var f=r(t.slice(l),p),d=0;d<f[0].length;d++)i(h,f[0][d]);for(var v=0;v<f[1].length;v++)i(s,f[1][v]);c=null;break}c=p[0]}null!=c&&i(s,c),t=h}return[t,s]};t.transform=t.transform=function(t,n,i){if("left"!==i&&"right"!==i)throw Error("type must be 'left' or 'right'");return 0===n.length?t:1===t.length&&1===n.length?e([],t[0],n[0],i):"left"===i?r(t,n)[0]:r(n,t)[1]}};var o=n.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(t){if(null!=t&&"string"!=typeof t)throw Error("Initial data must be a string");return t||""}},r=function(t,e,n){return t.slice(0,e)+n+t.slice(e)},s=function(t){if("number"!=typeof t.p)throw Error("component missing position field");if("string"==typeof t.i==("string"==typeof t.d))throw Error("component needs an i or d field");if(t.p<0)throw Error("position cannot be negative")},a=function(t){for(var e=0;e<t.length;e++)s(t[e])};o.apply=function(t,e){var n;a(e);for(var i=0;i<e.length;i++){var o=e[i];if(null!=o.i)t=r(t,o.p,o.i);else{if(n=t.slice(o.p,o.p+o.d.length),o.d!==n)throw Error("Delete component '"+o.d+"' does not match deleted text '"+n+"'");t=t.slice(0,o.p)+t.slice(o.p+o.d.length)}}return t};var c=o._append=function(t,e){if(""!==e.i&&""!==e.d)if(0===t.length)t.push(e);else{var n=t[t.length-1];null!=n.i&&null!=e.i&&n.p<=e.p&&e.p<=n.p+n.i.length?t[t.length-1]={i:r(n.i,e.p-n.p,e.i),p:n.p}:null!=n.d&&null!=e.d&&e.p<=n.p&&n.p<=e.p+e.d.length?t[t.length-1]={d:r(e.d,n.p-e.p,n.d),p:e.p}:t.push(e)}};o.compose=function(t,e){a(t),a(e);for(var n=t.slice(),i=0;i<e.length;i++)c(n,e[i]);return n},o.normalize=function(t){var e=[];(null!=t.i||null!=t.p)&&(t=[t]);for(var n=0;n<t.length;n++){var i=t[n];null==i.p&&(i.p=0),c(e,i)}return e};var h=function(t,e,n){return null!=e.i?e.p<t||e.p===t&&n?t+e.i.length:t:t<=e.p?t:t<=e.p+e.d.length?e.p:t-e.d.length};o.transformCursor=function(t,e,n){for(var i="right"===n,o=0;o<e.length;o++)t=h(t,e[o],i);return t};var l=o._tc=function(t,e,n,i){if(s(e),s(n),null!=e.i)c(t,{i:e.i,p:h(e.p,n,"right"===i)});else if(null!=n.i){var o=e.d;e.p<n.p&&(c(t,{d:o.slice(0,n.p-e.p),p:e.p}),o=o.slice(n.p-e.p)),""!==o&&c(t,{d:o,p:e.p+n.i.length})}else if(e.p>=n.p+n.d.length)c(t,{d:e.d,p:e.p-n.d.length});else if(e.p+e.d.length<=n.p)c(t,e);else{var r={d:"",p:e.p};e.p<n.p&&(r.d=e.d.slice(0,n.p-e.p)),e.p+e.d.length>n.p+n.d.length&&(r.d+=e.d.slice(n.p+n.d.length-e.p));var a=Math.max(e.p,n.p),l=Math.min(e.p+e.d.length,n.p+n.d.length),p=e.d.slice(a-e.p,l-e.p),u=n.d.slice(a-n.p,l-n.p);if(p!==u)throw Error("Delete ops delete different text in the same region of the document");""!==r.d&&(r.p=h(r.p,n),c(t,r))}return t},p=function(t){return null!=t.i?{d:t.i,p:t.p}:{i:t.d,p:t.p}};o.invert=function(t){t=t.slice().reverse();for(var e=0;e<t.length;e++)t[e]=p(t[e]);return t},i._bootstrapTransform?i._bootstrapTransform(o,l,a,c):require("./helpers")._bootstrapTransform(o,l,a,c);var u=function(t){return"[object Array]"==Object.prototype.toString.call(t)},f=function(t){return!!t&&t.constructor===Object},d=function(t){return JSON.parse(JSON.stringify(t))},v={name:"json0",uri:"http://sharejs.org/types/JSONv0"},g={};v.registerSubtype=function(t){g[t.name]=t},v.create=function(t){return void 0===t?null:d(t)},v.invertComponent=function(t){var e={p:t.p};return t.t&&g[t.t]&&(e.t=t.t,e.o=g[t.t].invert(t.o)),void 0!==t.si&&(e.sd=t.si),void 0!==t.sd&&(e.si=t.sd),void 0!==t.oi&&(e.od=t.oi),void 0!==t.od&&(e.oi=t.od),void 0!==t.li&&(e.ld=t.li),void 0!==t.ld&&(e.li=t.ld),void 0!==t.na&&(e.na=-t.na),void 0!==t.lm&&(e.lm=t.p[t.p.length-1],e.p=t.p.slice(0,t.p.length-1).concat([t.lm])),e},v.invert=function(t){for(var e=t.slice().reverse(),n=[],i=0;i<e.length;i++)n.push(v.invertComponent(e[i]));return n},v.checkValidOp=function(t){for(var e=0;e<t.length;e++)if(!u(t[e].p))throw Error("Missing path")},v.checkList=function(t){if(!u(t))throw Error("Referenced element not a list")},v.checkObj=function(t){if(!f(t))throw Error("Referenced element not an object (it was "+JSON.stringify(t)+")")},v.apply=function(e,n){v.checkValidOp(n),n=d(n);for(var i={data:e},o=0;o<n.length;o++){var r=n[o];(null!=r.si||null!=r.sd)&&t(r);for(var s=null,a=null,c=i,h="data",l=0;l<r.p.length;l++){var p=r.p[l];if(s=c,a=h,c=c[h],h=p,null==s)throw Error("Path invalid")}if(r.t&&void 0!==r.o&&g[r.t])c[h]=g[r.t].apply(c[h],r.o);else if(void 0!==r.na){if("number"!=typeof c[h])throw Error("Referenced element not a number");c[h]+=r.na}else if(void 0!==r.li&&void 0!==r.ld)v.checkList(c),c[h]=r.li;else if(void 0!==r.li)v.checkList(c),c.splice(h,0,r.li);else if(void 0!==r.ld)v.checkList(c),c.splice(h,1);else if(void 0!==r.lm){if(v.checkList(c),r.lm!=h){var u=c[h];c.splice(h,1),c.splice(r.lm,0,u)}}else if(void 0!==r.oi)v.checkObj(c),c[h]=r.oi;else{if(void 0===r.od)throw Error("invalid / missing instruction in op");v.checkObj(c),delete c[h]}}return i.data},v.shatter=function(t){for(var e=[],n=0;n<t.length;n++)e.push([t[n]]);return e},v.incrementalApply=function(t,e,n){for(var i=0;i<e.length;i++){var o=[e[i]];t=v.apply(t,o),n(o,t)}return t};var m=v.pathMatches=function(t,e,n){if(t.length!=e.length)return!1;for(var i=0;i<t.length;i++)if(t[i]!==e[i]&&(!n||i!==t.length-1))return!1;return!0};if(v.append=function(n,i){if(i=d(i),0===n.length)return void n.push(i);var o=n[n.length-1];if(null==i.si&&null==i.sd||null==o.si&&null==o.sd||(t(i),t(o)),m(i.p,o.p))if(i.t&&o.t&&i.t===o.t&&g[i.t]){if(o.o=g[i.t].compose(o.o,i.o),null!=i.si||null!=i.sd){for(var r=i.p,s=0;s<o.o.length-1;s++)i.o=[o.o.pop()],i.p=r.slice(),e(i),n.push(i);e(o)}}else null!=o.na&&null!=i.na?n[n.length-1]={p:o.p,na:o.na+i.na}:void 0!==o.li&&void 0===i.li&&i.ld===o.li?void 0!==o.ld?delete o.li:n.pop():void 0!==o.od&&void 0===o.oi&&void 0!==i.oi&&void 0===i.od?o.oi=i.oi:void 0!==o.oi&&void 0!==i.od?void 0!==i.oi?o.oi=i.oi:void 0!==o.od?delete o.oi:n.pop():void 0!==i.lm&&i.p[i.p.length-1]===i.lm||n.push(i);else null==i.si&&null==i.sd||null==o.si&&null==o.sd||(e(i),e(o)),n.push(i)},v.compose=function(t,e){v.checkValidOp(t),v.checkValidOp(e);for(var n=d(t),i=0;i<e.length;i++)v.append(n,e[i]);return n},v.normalize=function(t){var e=[];t=u(t)?t:[t];for(var n=0;n<t.length;n++){var i=t[n];null==i.p&&(i.p=[]),v.append(e,i)}return e},v.commonLengthForOps=function(t,e){var n=t.p.length,i=e.p.length;if((null!=t.na||t.t)&&n++,(null!=e.na||e.t)&&i++,0===n)return-1;if(0===i)return null;n--,i--;for(var o=0;n>o;o++){var r=t.p[o];if(o>=i||r!==e.p[o])return null}return n},v.canOpAffectPath=function(t,e){return null!=v.commonLengthForOps({p:e},t)},v.transformComponent=function(n,i,o,r){i=d(i);var s=v.commonLengthForOps(o,i),a=v.commonLengthForOps(i,o),c=i.p.length,h=o.p.length;if((null!=i.na||i.t)&&c++,(null!=o.na||o.t)&&h++,null!=a&&h>c&&i.p[a]==o.p[a])if(void 0!==i.ld){var l=d(o);l.p=l.p.slice(c),i.ld=v.apply(d(i.ld),[l])}else if(void 0!==i.od){var l=d(o);l.p=l.p.slice(c),i.od=v.apply(d(i.od),[l])}if(null!=s){var p=c==h,l=o;if(null==i.si&&null==i.sd||null==o.si&&null==o.sd||(t(i),l=d(o),t(l)),l.t&&g[l.t]){if(i.t&&i.t===l.t){var u=g[i.t].transform(i.o,l.o,r);if(u.length>0)if(null!=i.si||null!=i.sd)for(var f=i.p,m=0;m<u.length;m++)i.o=[u[m]],i.p=f.slice(),e(i),v.append(n,i);else i.o=u,v.append(n,i);return n}}else if(void 0!==o.na);else if(void 0!==o.li&&void 0!==o.ld){if(o.p[s]===i.p[s]){if(!p)return n;if(void 0!==i.ld){if(void 0===i.li||"left"!==r)return n;i.ld=d(o.li)}}}else if(void 0!==o.li)void 0!==i.li&&void 0===i.ld&&p&&i.p[s]===o.p[s]?"right"===r&&i.p[s]++:o.p[s]<=i.p[s]&&i.p[s]++,void 0!==i.lm&&p&&o.p[s]<=i.lm&&i.lm++;else if(void 0!==o.ld){if(void 0!==i.lm&&p){if(o.p[s]===i.p[s])return n;var f=o.p[s],b=i.p[s],y=i.lm;(y>f||f===y&&y>b)&&i.lm--}if(o.p[s]<i.p[s])i.p[s]--;else if(o.p[s]===i.p[s]){if(c>h)return n;if(void 0!==i.ld){if(void 0===i.li)return n;delete i.ld}}}else if(void 0!==o.lm)if(void 0!==i.lm&&c===h){var b=i.p[s],y=i.lm,_=o.p[s],w=o.lm;if(_!==w)if(b===_){if("left"!==r)return n;i.p[s]=w,b===y&&(i.lm=w)}else b>_&&i.p[s]--,b>w?i.p[s]++:b===w&&_>w&&(i.p[s]++,b===y&&i.lm++),y>_?i.lm--:y===_&&y>b&&i.lm--,y>w?i.lm++:y===w&&(w>_&&y>b||_>w&&b>y?"right"===r&&i.lm++:y>b?i.lm++:y===_&&i.lm--)}else if(void 0!==i.li&&void 0===i.ld&&p){var b=o.p[s],y=o.lm;f=i.p[s],f>b&&i.p[s]--,f>y&&i.p[s]++}else{var b=o.p[s],y=o.lm;f=i.p[s],f===b?i.p[s]=y:(f>b&&i.p[s]--,f>y?i.p[s]++:f===y&&b>y&&i.p[s]++)}else if(void 0!==o.oi&&void 0!==o.od){if(i.p[s]===o.p[s]){if(void 0===i.oi||!p)return n;if("right"===r)return n;i.od=o.oi}}else if(void 0!==o.oi){if(void 0!==i.oi&&i.p[s]===o.p[s]){if("left"!==r)return n;v.append(n,{p:i.p,od:o.oi})}}else if(void 0!==o.od&&i.p[s]==o.p[s]){if(!p)return n;if(void 0===i.oi)return n;delete i.od}}return v.append(n,i),n},i._bootstrapTransform?i._bootstrapTransform(v,v.transformComponent,v.checkValidOp,v.append):require("./helpers")._bootstrapTransform(v,v.transformComponent,v.checkValidOp,v.append),void 0===o)var o="undefined"!=typeof require?require("./text0"):window.ottypes.text;v.registerSubtype(o),n.exports=v;var b=window.ottypes=window.ottypes||{},y=n.exports;b[y.name]=y,y.uri&&(b[y.uri]=y)}(),function(){function t(t){return 1===t.length&&t[0].constructor===Array?t[0]:t}function e(t,e){for(var n="data",i={data:t},o=0;o<e.length;o++)if(i=i[n],n=e[o],void 0===i)throw Error("bad path");return{elem:i,key:n}}function n(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;++n)if(t[n]!==e[n])return!1;return!0}function i(t,e){return t.length<e.length?!1:n(t.slice(0,e.length),e)}function o(){}function r(t){return t instanceof Array?t:"number"==typeof t?[t]:void 0}function s(t,e,n,i){e=Array.prototype.slice.call(e);var s=t.path||[];return n.length>1&&"function"!=typeof e[e.length-1]&&e.push(o),e.length<(i||n.length)?e.unshift(s):e[0]=s.concat(r(e[0])),n.apply(t,e)}var a=[].slice,c="undefined"!=typeof require?require("ottypes"):window.ottypes,h=c["http://sharejs.org/types/JSONv0"],l=function(t,e){this.context=t,this.path=e||[]};l.prototype._updatePath=function(t){console.log("UPDATEPATH",t);for(var e=0;e<t.length;e++){var n=t[e];if(void 0!==n.lm&&i(this.path,n.p)){var o=n.p.slice(0,n.p.length-1);o.push(n.lm),this.path=o.concat(this.path.slice(o.length))}}},l.prototype.createContextAt=function(){var e=1<=arguments.length?a.call(arguments,0):[];return this.context.createContextAt(this.path.concat(t(e)))},l.prototype.get=function(){return s(this,arguments,function(t){return this.context.get(t)})},l.prototype.set=function(){return s(this,arguments,function(t,e,n){return this.context.set(t,e,n)})},l.prototype.insert=function(){return s(this,arguments,function(t,e,n){return this.context.insert(t,e,n)})},l.prototype.remove=function(){return s(this,arguments,function(t,e,n){return this.context.remove(t,e,n)},2)},l.prototype.push=function(){return s(this,arguments,function(t,n,i){var o=e(this.context.getSnapshot(),t),r=o.elem[o.key].length;return t.push(r),this.context.insert(t,n,i)})},l.prototype.move=function(){return s(this,arguments,function(t,e,n,i){return console.log("sd MOVE"),this.context.move(t,e,n,i)})},l.prototype.add=function(){return s(this,arguments,function(t,e,n){return this.context.add(t,e,n)})},l.prototype.on=function(t,e){return this.context.addListener(this.path,t,e)},l.prototype.removeListener=function(t){return this.context.removeListener(t)},l.prototype.getLength=function(){return s(this,arguments,function(t){return this.context.getLength(t)})},l.prototype.getText=function(){return s(this,arguments,function(t){return this.context.getText(t)})},l.prototype.deleteText=function(){return s(this,arguments,function(t,e,n,i){return this.context.deleteText(t,n,e,i)})},l.prototype.destroy=function(){this.context._removeSubDoc(this)},h.api={provides:{json:!0},_fixComponentPaths:function(t){if(this._listeners&&void 0===t.na&&void 0===t.si&&void 0===t.sd){for(var e=[],n=this._listeners,i=0;i<n.length;i++){var o=n[i],r={p:o.path,na:0},s=h.transformComponent([],r,t,"left");if(0===s.length)e.push(i);else{if(1!==s.length)throw Error("Bad assumption in json-api: xforming an 'na' op will always result in 0 or 1 components.");o.path=s[0].p}}e.sort(function(t,e){return e-t});for(var a=[],c=0;c<e.length;c++)i=e[c],a.push(this._listeners.splice(i,1));return a}},_fixPaths:function(t){for(var e=[],n=0;n<t.length;n++){var i=t[n];e.push(this._fixComponentPaths(i))}return e},_submit:function(t,e){return this._fixPaths(t),this.submitOp(t,e)},_addSubDoc:function(t){this._subdocs||(this._subdocs=[]),this._subdocs.push(t)},_removeSubDoc:function(t){this._subdocs||(this._subdocs=[]);for(var e=0;e<this._subdocs.length;e++)return void(this._subdocs[e]===t&&this._subdocs.splice(e,1))},_updateSubdocPaths:function(t){this._subdocs||(this._subdocs=[]);for(var e=0;e<this._subdocs.length;e++)this._subdocs[e]._updatePath(t)},createContextAt:function(){var e=1<=arguments.length?a.call(arguments,0):[],n=new l(this,t(e));return this._addSubDoc(n),n},get:function(t){return t?s(this,arguments,function(t){var n=e(this.getSnapshot(),t);return n.elem[n.key]}):this.getSnapshot()},set:function(){return s(this,arguments,function(t,n,i){var o=e(this.getSnapshot(),t),r=o.elem,s=o.key,a={p:t};if(r.constructor===Array)a.li=n,void 0!==r[s]&&(a.ld=r[s]);else{if("object"!=typeof r)throw Error("bad path");a.oi=n,void 0!==r[s]&&(a.od=r[s])}return this._submit([a],i)})},remove:function(){return s(this,arguments,function(t,n,i){!i&&n instanceof Function&&(i=n,n=null);var o,r,s,a;if(null===n||void 0===n){if(o=e(this.getSnapshot(),t),r=o.elem,a=o.key,s={p:t},void 0===r[a])throw Error("no element at that path");if(r.constructor===Array)s.ld=r[a];else{if("object"!=typeof r)throw Error("bad path");s.od=r[a]}return this._submit([s],i)}var c;if(c=t.pop(),o=e(this.getSnapshot(),t),r=o.elem,a=o.key,"string"==typeof r[a])return s={p:t.concat(c),sd:o.elem[o.key].slice(c,c+n)},this._submit([s],i);if(r[a].constructor===Array){for(var h=[],l=c;c+n>l;l++)h.push({p:t.concat(c),ld:r[a][l]});return this._submit(h,i)}throw Error("element at path does not support range")},2)},insert:function(){return s(this,arguments,function(t,n,i){var o=t.pop(),r=e(this.getSnapshot(),t),s=r.elem,a=r.key,c={p:t.concat(o)};return s[a].constructor===Array?c.li=n:"string"==typeof s[a]&&(c.si=n),this._submit([c],i)})},move:function(){return s(this,arguments,function(t,e,n,i){var o=this,r=[{p:t.concat(e),lm:n}];return this._submit(r,function(){o._updateSubdocPaths(r),i&&i.apply(i,arguments)})})},push:function(){return s(this,arguments,function(t,n,i){var o=e(this.getSnapshot(),t),r=o.elem[o.key].length;return t.push(r),this.insert(t,n,i)})},add:function(t,e){return s(this,arguments,function(t,n,i){var o=[{p:t,na:e}];return this._submit(o,i)})},getLength:function(){return s(this,arguments,function(t){return this.get(t).length})},getText:function(){return s(this,arguments,function(t){return console.warn("Deprecated. Use `get()` instead"),this.get(t)})},deleteText:function(){return s(this,arguments,function(t,n,i,o){console.warn("Deprecated. Use `remove(path, length, cb)` instead");var r=e(this.getSnapshot(),t),s=[{p:t.concat(i),sd:r.elem[r.key].slice(i,i+n)}];return this._submit(s,o)})},addListener:function(t,e){return s(this,arguments,function(t,n,i){var o={path:t,event:e,cb:i};return this._listeners||(this._listeners=[]),this._listeners.push(o),o})},removeListener:function(t){if(this._listeners){var e=this._listeners.indexOf(t);return 0>e?!1:(this._listeners.splice(e,1),!0)}},_onOp:function(t){for(var e=0;e<t.length;e++){var i=t[e];this._fixComponentPaths(i),void 0!==i.lm&&this._updateSubdocPaths([i]);for(var o=void 0===i.na?i.p.slice(0,i.p.length-1):i.p,r=0;r<this._listeners.length;r++){var s=this._listeners[r],a=s.cb;if(n(s.path,o))switch(s.event){case"insert":void 0!==i.li&&void 0===i.ld?a(i.p[i.p.length-1],i.li):void 0!==i.oi&&void 0===i.od?a(i.p[i.p.length-1],i.oi):void 0!==i.si&&a(i.p[i.p.length-1],i.si);break;case"delete":void 0===i.li&&void 0!==i.ld?a(i.p[i.p.length-1],i.ld):void 0===i.oi&&void 0!==i.od?a(i.p[i.p.length-1],i.od):void 0!==i.sd&&a(i.p[i.p.length-1],i.sd);break;case"replace":void 0!==i.li&&void 0!==i.ld?a(i.p[i.p.length-1],i.ld,i.li):void 0!==i.oi&&void 0!==i.od&&a(i.p[i.p.length-1],i.od,i.oi);break;case"move":void 0!==i.lm&&a(i.p[i.p.length-1],i.lm);break;case"add":void 0!==i.na&&a(i.na)}if(h.canOpAffectPath(i,s.path)&&"child op"===s.event){var c=i.p.slice(s.path.length);a(c,i)}}}}}}.call(this);var n=window.sharejs={version:"0.7.0-alpha13"},i=function(){};i.prototype.on=function(t,e){var n=this._events=this._events||{};(n[t]=n[t]||[]).push(e)},i.prototype.removeListener=function(t,e){for(var n=this._events=this._events||{},i=n[t]=n[t]||[],o=0;o<i.length;)i[o]===e&&(i[o]=void 0),o++;setTimeout(function(){n[t]=[];for(var e,o=0;o<i.length;o++)(e=i[o])&&n[t].push(e)},0)},i.prototype.emit=function(t){var e=this._events,n=Array.prototype.splice.call(arguments,1);if(!e||!e[t])return void("error"==t&&console&&console.error.apply(console,n));for(var i=e[t],o=0;o<i.length;o++)i[o]&&i[o].apply(this,n)},i.prototype.once=function(t,e){var n,i=this;this.on(t,n=function(){i.removeListener(t,n),e.apply(i,arguments)})},i.mixin=function(t){var e=t.prototype||t;return e.on=i.prototype.on,e.removeListener=i.prototype.removeListener,e.emit=i.prototype.emit,e.once=i.prototype.once,t},"undefined"!=typeof module&&(module.exports=i);var o;o="undefined"!=typeof require?require("ottypes"):window.ottypes,n.registerType=function(t){t.name&&(o[t.name]=t),t.uri&&(o[t.uri]=t)};var o,i;"undefined"!=typeof require?(o=require("ottypes"),i=require("./microevent")):o=window.ottypes;var r=n.Doc=function(t,e,n){this.connection=t,this.collection=e,this.name=n,this.version=this.type=null,this.snapshot=void 0,this.action=null,this.state=null,this.subscribed=!1,this.wantSubscribe=!1,this._subscribeCallbacks=[],this.provides={},this.editingContexts=[],this.inflightData=null,this.pendingData=[],this.type=null};i.mixin(r),r.prototype.destroy=function(t){var e=this;this.unsubscribe(function(){e.hasPending()?e.once("nothing pending",function(){e.connection._destroyDoc(e)}):e.connection._destroyDoc(e),e.removeContexts(),t&&t()})},r.prototype._setType=function(t){if("string"==typeof t){if(!o[t])throw Error("Missing type "+t+" "+this.collection+" "+this.name);t=o[t]}this.removeContexts(),this.type=t,t?t.api&&(this.provides=t.api.provides):(this.provides={},this.snapshot=void 0)},r.prototype.ingestData=function(t){if("number"!=typeof t.v)throw Error("Missing version in ingested data "+this.collection+" "+this.name);if(this.state){if(this.version>=t.v)return;return void console.warn("Ignoring ingest data for",this.collection,this.name,"\n  in state:",this.state,"\n  version:",this.version,"\n  snapshot:\n",this.snapshot,"\n  incoming data:\n",t)}this.version=t.v,this.snapshot=t.data,this._setType(t.type),this.state="ready",this.emit("ready")},r.prototype.getSnapshot=function(){return this.snapshot},r.prototype.whenReady=function(t){"ready"===this.state?t():this.once("ready",t)},r.prototype.retry=function(){if(this.inflightData){var t=5e3*Math.pow(2,this.inflightData.retries);this.inflightData.sentAt<Date.now()-t&&(this.connection.emit("retry",this),this._clearAction())}},r.prototype.hasPending=function(){return null!=this.action||null!=this.inflightData||!!this.pendingData.length},r.prototype._send=function(t){t.c=this.collection,t.d=this.name,this.connection.send(t)},r.prototype._handleSubscribe=function(t,e){return t&&"Already subscribed"!==t?(console.error("Could not subscribe:",t,this.collection,this.name),this.emit("error",t),void this._setWantSubscribe(!1,null,t)):(e&&this.ingestData(e),this.subscribed=!0,this._clearAction(),this.emit("subscribe"),void this._finishSub())},r.prototype._finishQuerySubscribe=function(t){return t>this.version?this.subscribe():(this.subscribed=!0,this.wantSubscribe=!0,this.emit("subscribe"),void this._finishSub())},r.prototype._onMessage=function(t){if(t.c!==this.collection||t.d!==this.name)throw Error("Got message for wrong document. "+this.collection+" "+this.name);switch(t.a){case"fetch":t.data&&this.ingestData(t.data),"fetch"===this.wantSubscribe&&(this.wantSubscribe=!1),this._clearAction(),this._finishSub(t.error);break;case"sub":this._handleSubscribe(t.error,t.data);break;case"unsub":this.subscribed=!1,this.emit("unsubscribe"),this._clearAction(),this._finishSub(t.error);break;case"ack":t.error&&"Op already submitted"!==t.error&&(this.inflightData?(console.warn("Operation was rejected ("+t.error+"). Trying to rollback change locally."),this._tryRollback(this.inflightData),this._clearInflightOp(t.error)):console.warn("Second acknowledgement message (error) received",t,this));break;case"op":if(this.inflightData&&t.src===this.inflightData.src&&t.seq===this.inflightData.seq){this._opAcknowledged(t);break}if(t.v<this.version)break;if(t.v>this.version){console.warn("Client got future operation from the server",this.collection,this.name,t),this._getLatestOps();break}this.inflightData&&h(this.inflightData,t);for(var e=0;e<this.pendingData.length;e++)h(this.pendingData[e],t);this.version++,this._otApply(t,!1);break;case"meta":console.warn("Unhandled meta op:",t);break;default:console.warn("Unhandled document message:",t)}},r.prototype._getLatestOps=function(){this._send({a:"fetch",v:this.version})},r.prototype._onConnectionStateChanged=function(t){"connecting"===t||"connected"===t?this.flush():"disconnected"===t&&(this._clearAction(),this.subscribed=!1)},r.prototype._clearAction=function(){this.action=null,this.flush(),this.hasPending()||this.emit("nothing pending")},r.prototype.flush=function(){if(this.connection.canSend&&!this.action){if(this.inflightData)return void this._sendOpData();for(var t;this.pendingData.length&&a(t=this.pendingData[0]);){for(var e=t.callbacks,n=0;n<e.length;n++)e[n](t.error);this.pendingData.shift()}!this.paused&&this.pendingData.length&&"connected"===this.connection.state?(this.inflightData=this.pendingData.shift(),this._sendOpData()):this.subscribed&&!this.wantSubscribe?(this.action="unsubscribe",this._send({a:"unsub"})):this.subscribed||"fetch"!==this.wantSubscribe?!this.subscribed&&this.wantSubscribe&&(this.action="subscribe",this.connection.sendSubscribe(this.collection,this.name,"ready"===this.state?this.version:null)):(this.action="fetch",this._send("ready"===this.state?{a:"fetch",v:this.version}:{a:"fetch"}))}},r.prototype._setWantSubscribe=function(t,e,n){return this.subscribed===this.wantSubscribe&&(this.subscribed===t||"fetch"===t&&this.subscribed)?void(e&&e(n)):(("fetch"!==t||this.wantSubscribe!==!0)&&(this.wantSubscribe=t),e&&this._subscribeCallbacks.push(e),void this.flush())},r.prototype.subscribe=function(t){this._setWantSubscribe(!0,t)},r.prototype.unsubscribe=function(t){this._setWantSubscribe(!1,t)},r.prototype.fetch=function(t){this._setWantSubscribe("fetch",t)},r.prototype._finishSub=function(t){if(this._subscribeCallbacks.length){for(var e=0;e<this._subscribeCallbacks.length;e++)this._subscribeCallbacks[e](t);this._subscribeCallbacks.length=0}};var s=function(t){delete t.op,delete t.create,delete t.del},a=function(t){return!t.op&&!t.create&&!t.del},c=function(t,e,n){if(e.create&&n.del)s(e);else if(e.create&&n.op){var i=void 0===e.create.data?t.create():e.create.data;e.create.data=t.apply(i,n.op)}else if(a(e))e.create=n.create,e.del=n.del,e.op=n.op;else{if(!(e.op&&n.op&&t.compose))return!1;e.op=t.compose(e.op,n.op)}return!0},h=function(t,e){if(e.create||e.del)return s(t);if(t.create)throw Error("Invalid state. This is a bug. "+this.collection+" "+this.name);if(t.del)return s(e);if(e.op&&t.op)if(t.type.transformX){var n=t.type.transformX(t.op,e.op);t.op=n[0],e.op=n[1]}else{var i=t.type.transform(t.op,e.op,"left"),o=t.type.transform(e.op,t.op,"right");t.op=i,e.op=o}};r.prototype._otApply=function(t,e){if(this.locked=!0,t.create){var n=t.create;this._setType(n.type),this.snapshot=this.type.create(n.data),this.once("unlock",function(){this.emit("create",e)})}else if(t.del){var i=this.snapshot;this._setType(null),this.once("unlock",function(){this.emit("del",e,i)})}else if(t.op){if(!this.type)throw Error("Document does not exist. "+this.collection+" "+this.name);for(var o=this.type,r=t.op,s=0;s<this.editingContexts.length;s++){var a=this.editingContexts[s];a!=e&&a._beforeOp&&a._beforeOp(t.op)}if(this.emit("before op",r,e),this.incremental&&o.incrementalApply){var c=this;o.incrementalApply(this.snapshot,r,function(t,n){c.snapshot=n,c.emit("op",t,e)})}else this.snapshot=o.apply(this.snapshot,r),this.emit("op",r,e)}if(this.locked=!1,this.emit("unlock"),t.op){for(var h=this.editingContexts,s=0;s<h.length;s++){var a=h[s];a!=e&&a._onOp&&a._onOp(t.op)}for(var s=0;s<h.length;s++)h.remove&&h.splice(s--,1);return this.emit("after op",t.op,e)}},r.prototype._sendOpData=function(){var t=this.inflightData;if(this.action)throw Error("Invalid state "+this.action+" for sendOpData. "+this.collection+" "+this.name);this.action="submit",t.sentAt=Date.now(),t.retries=null==t.retries?0:t.retries+1;var e={a:"op",v:this.version};t.src&&(e.src=t.src,e.seq=t.seq),t.op&&(e.op=t.op),t.create&&(e.create=t.create),t.del&&(e.del=t.del),e.c=this.collection,e.d=this.name,this.connection.sendOp(e),t.src||(t.src=this.connection.id,t.seq=this.connection.seq++)},r.prototype._submitOpData=function(t,e,n){"function"==typeof e&&(n=e,e=!0),null==e&&(e=!0);var i=function(t){return n?n(t):void console.warn("Failed attempt to submitOp:",t)};if(this.locked)return i("Cannot call submitOp from inside an 'op' event handler. "+this.collection+" "+this.name);if(t.op){if(!this.type)return i("Document has not been created");this.type.normalize&&(t.op=this.type.normalize(t.op))}this.state||(this.state="floating"),t.type=this.type,t.callbacks=[];var o,r=this.pendingData[this.pendingData.length-1];r&&c(this.type,r,t)?o=r:(o=t,this.pendingData.push(t)),n&&o.callbacks.push(n),this._otApply(t,e);var s=this;setTimeout(function(){s.flush()},0)},r.prototype.submitOp=function(t,e,n){this._submitOpData({op:t},e,n)},r.prototype.create=function(t,e,n,i){"function"==typeof e&&(n=e,e=void 0);var o={create:{type:t,data:e}};return this.type?void(i&&i("Document already exists",this._opErrorContext(o))):void this._submitOpData(o,n,i)},r.prototype.del=function(t,e){return this.type?void this._submitOpData({del:!0},t,e):void(e&&e("Document does not exist"))},r.prototype.pause=function(){this.paused=!0},r.prototype.resume=function(){this.paused=!1,this.flush()},r.prototype._tryRollback=function(t){if(t.create)this._setType(null),"floating"===this.state?this.state=null:console.warn("Rollback a create from state "+this.state);else if(t.op&&t.type.invert){t.op=t.type.invert(t.op);for(var e=0;e<this.pendingData.length;e++)h(this.pendingData[e],t);this._otApply(t,!1)}else(t.op||t.del)&&(this._setType(null),this.version=null,this.state=null,this.subscribed=!1,this.emit("error","Op apply failed and the operation could not be reverted"),this.fetch(),this.flush())},r.prototype._opErrorContext=function(t){return{collection:this.collection,name:this.name,opData:t||this.inflightData}},r.prototype._clearInflightOp=function(t){for(var e=this.inflightData.callbacks,n=this._opErrorContext(),i=0;i<e.length;i++)e[i](t||this.inflightData.error,n);this.inflightData=null,this._clearAction();

},r.prototype._opAcknowledged=function(t){if(!this.state)throw Error("opAcknowledged called from a null state. This should never happen. "+this.collection+" "+this.name);if("floating"===this.state){if(!this.inflightData.create)throw Error("Cannot acknowledge an op. "+this.collection+" "+this.name);this.version=t.v,this.state="ready";var e=this;setTimeout(function(){e.emit("ready")},0)}else if(t.v!==this.version)throw Error("Invalid version from server. This can happen when you submit ops in a submitOp callback. Expected: "+this.version+" Message version: "+t.v+" "+this.collection+" "+this.name);this.version++,this._clearInflightOp()},r.prototype.createContext=function(){var t=this.type;if(!t)throw Error("Missing type "+this.collection+" "+this.name);var e=this,n={getSnapshot:function(){return e.snapshot},submitOp:function(t,i){e.submitOp(t,n,i)},destroy:function(){this.detach&&(this.detach(),delete this.detach),delete this._onOp,this.remove=!0},_doc:this};if(t.api)for(var i in t.api)n[i]=t.api[i];else n.provides={};return this.editingContexts.push(n),n},r.prototype.removeContexts=function(){for(var t=0;t<this.editingContexts.length;t++)this.editingContexts[t].destroy();this.editingContexts.length=0};var r,l,i;"undefined"!=typeof require?(r=require("./doc").Doc,l=require("./query").Query,i=require("./microevent")):(r=n.Doc,l=n.Query);var p=n.Connection=function(t){this.collections={},this.nextQueryId=1,this.queries={},this.state="disconnected",this.canSend=!1,this._retryInterval=null,this.reset(),this.debug=!1,this.messageBuffer=[],this.bindToSocket(t)};i.mixin(p),p.prototype.bindToSocket=function(t){this.socket&&(delete this.socket.onopen,delete this.socket.onclose,delete this.socket.onmessage,delete this.socket.onerror),this.socket=t,this.state=0===t.readyState||1===t.readyState?"connecting":"disconnected",this.canSend="connecting"===this.state&&t.canSendWhileConnecting,this._setupRetry();var e=this;t.onmessage=function(t){var n=t.data;for(n||(n=t),"string"==typeof n&&(n=JSON.parse(n)),e.debug&&console.log("RECV",JSON.stringify(n)),e.messageBuffer.push({t:(new Date).toTimeString(),recv:JSON.stringify(n)});e.messageBuffer.length>100;)e.messageBuffer.shift();try{e.handleMessage(n)}catch(i){throw e.emit("error",i),i}},t.onopen=function(){e._setState("connecting")},t.onerror=function(t){e.emit("connection error",t)},t.onclose=function(t){e._setState("disconnected",t),("Closed"===t||"Stopped by server"===t)&&e._setState("stopped",t)}},p.prototype.handleMessage=function(t){switch(t.a){case"init":if(0!==t.protocol)throw Error("Invalid protocol version");if("string"!=typeof t.id)throw Error("Invalid client id");this.id=t.id,this._setState("connected");break;case"qfetch":case"qsub":case"q":case"qunsub":var e=this.queries[t.id];e&&e._onMessage(t);break;case"bs":var n=t.s;for(var i in n)for(var o in n[i]){var r=this.get(i,o);if(!r){console&&console.error("Message for unknown doc. Ignoring.",t);break}var t=n[i][o];"object"==typeof t?r._handleSubscribe(t.error,t):r._handleSubscribe(null,null)}break;default:var s,o,r;t.d?(s=this._lastReceivedCollection=t.c,o=this._lastReceivedDoc=t.d):(s=t.c=this._lastReceivedCollection,o=t.d=this._lastReceivedDoc);var r=this.getExisting(s,o);r&&r._onMessage(t)}},p.prototype.reset=function(){this.id=this.lastError=this._lastReceivedCollection=this._lastReceivedDoc=this._lastSentCollection=this._lastSentDoc=null,this.seq=1},p.prototype._setupRetry=function(){if(!this.canSend)return clearInterval(this._retryInterval),void(this._retryInterval=null);if(null==this._retryInterval){var t=this;this._retryInterval=setInterval(function(){for(var e in t.collections){var n=t.collections[e];for(var i in n)n[i].retry()}},1e3)}},p.prototype._setState=function(t,e){if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state&&"stopped"!==this.state||"connected"===t&&"connecting"!==this.state)throw Error("Cannot transition directly from "+this.state+" to "+t);this.state=t,this.canSend="connecting"===t&&this.socket.canSendWhileConnecting||"connected"===t,this._setupRetry(),"disconnected"===t&&this.reset(),this.emit(t,e);var n={};for(var i in this.queries){var o=this.queries[i];if(o._onConnectionStateChanged(t,e),"sub"===o.docMode&&("connecting"===t||"connected"===t))for(var r=n[o.collection]||(n[o.collection]={}),s=0;s<o.results.length;s++)r[o.results[s].name]=!0}this.opQueue=[],this.bsStart();for(var a in this.collections){var c=this.collections[a];for(var h in c)n[a]&&n[a][h]||c[h]._onConnectionStateChanged(t,e)}this.opQueue.sort(function(t,e){return t.seq-e.seq});for(var s=0;s<this.opQueue.length;s++)this.send(this.opQueue[s]);this.opQueue=null,this.bsEnd()}},p.prototype.sendOp=function(t){this.opQueue?this.opQueue.push(t):this.send(t)},p.prototype.bsStart=function(){this.subscribeData={}},p.prototype.bsEnd=function(){t(this.subscribeData)&&this.send({a:"bs",s:this.subscribeData}),this.subscribeData=null},p.prototype.sendSubscribe=function(t,e,n){if(this.subscribeData){var i=this.subscribeData;i[t]||(i[t]={}),i[t][e]=n||null}else{var o={a:"sub",c:t,d:e};null!=n&&(o.v=n),this.send(o)}},p.prototype.send=function(t){for(this.debug&&console.log("SEND",JSON.stringify(t)),this.messageBuffer.push({t:Date.now(),send:JSON.stringify(t)});this.messageBuffer.length>100;)this.messageBuffer.shift();if(t.d){var e=t.c,n=t.d;e===this._lastSentCollection&&n===this._lastSentDoc?(delete t.c,delete t.d):(this._lastSentCollection=e,this._lastSentDoc=n)}this.socket.canSendJSON||(t=JSON.stringify(t)),this.socket.send(t)},p.prototype.disconnect=function(){this.socket.close()},p.prototype.getExisting=function(t,e){return this.collections[t]?this.collections[t][e]:void 0},p.prototype.getOrCreate=function(t,e,n){return console.trace("getOrCreate is deprecated. Use get() instead"),this.get(t,e,n)},p.prototype.get=function(t,e,n){var i=this.collections[t];i||(i=this.collections[t]={});var o=i[e];return o||(o=i[e]=new r(this,t,e)),n&&void 0!==n.data&&!o.state&&o.ingestData(n),o},p.prototype._destroyDoc=function(e){var n=this.collections[e.collection];n&&(delete n[e.name],t(n)||delete this.collections[e.collection])},p.prototype._createQuery=function(t,e,n,i,o){if("fetch"!==t&&"sub"!==t)throw Error("Invalid query type: "+t);i||(i={});var r=this.nextQueryId++,s=new l(t,this,r,e,n,i,o);return this.queries[r]=s,s._execute(),s},p.prototype._destroyQuery=function(t){delete this.queries[t.id]},p.prototype.createFetchQuery=function(t,e,n,i){return this._createQuery("fetch",t,e,n,i)},p.prototype.createSubscribeQuery=function(t,e,n,i){return this._createQuery("sub",t,e,n,i)};var u=function(t,e,n){if(e!==n){for(var i=0;e.charAt(i)===n.charAt(i);)i++;for(var o=0;e.charAt(e.length-1-o)===n.charAt(n.length-1-o)&&o+i<e.length&&o+i<n.length;)o++;e.length!==i+o&&t.remove(i,e.length-i-o),n.length!==i+o&&t.insert(i,n.slice(i,n.length-o))}};window.sharejs.Doc.prototype.attachTextarea=function(t,e){if(e||(e=this.createContext()),!e.provides.text)throw Error("Cannot attach to non-text document");t.value=e.get();var n,i=function(e,i){if(i)var o=[i(t.selectionStart),i(t.selectionEnd)];var r=t.scrollTop;t.value=e,n=t.value,t.scrollTop!==r&&(t.scrollTop=r),o&&window.document.activeElement===t&&(t.selectionStart=o[0],t.selectionEnd=o[1])};i(e.get()),e.onInsert=function(e,n){var o=function(t){return t>e?t+n.length:t},r=t.value.replace(/\r\n/g,"\n");i(r.slice(0,e)+n+r.slice(e),o)},e.onRemove=function(e,n){var o=function(t){return t>e?t-Math.min(n,t-e):t},r=t.value.replace(/\r\n/g,"\n");i(r.slice(0,e)+r.slice(e+n),o)};for(var o=function(){setTimeout(function(){t.value!==n&&(n=t.value,u(e,e.get(),t.value.replace(/\r\n/g,"\n")))},0)},r=["textInput","keydown","keyup","select","cut","paste"],s=0;s<r.length;s++){var a=r[s];t.addEventListener?t.addEventListener(a,o,!1):t.attachEvent("on"+a,o)}return e.detach=function(){for(var e=0;e<r.length;e++){var n=r[e];t.removeEventListener?t.removeEventListener(n,o,!1):t.detachEvent("on"+n,o)}},e};var r;"undefined"!=typeof require&&(r=require("./doc").Doc);var l=n.Query=function(t,e,n,i,o,r,s){this.type=t,this.connection=e,this.id=n,this.collection=i,this.query=o,this.docMode=r.docMode,"subscribe"===this.docMode&&(this.docMode="sub"),this.poll=r.poll,this.backend=r.backend||r.source,this.knownDocs=r.knownDocs||[],this.results=[],this.ready=!1,this.callback=s};l.prototype.action="qsub",l.prototype._execute=function(){if(this.connection.canSend){if(this.docMode)for(var t={},e=0;e<this.knownDocs.length;e++){var n=this.knownDocs[e],i=t[n.collection]=t[n.collection]||{};i[n.name]=n.version}var o={a:"q"+this.type,id:this.id,c:this.collection,o:{},q:this.query};this.docMode&&(o.o.m=this.docMode,o.o.vs=t),null!=this.backend&&(o.o.b=this.backend),void 0!==this.poll&&(o.o.p=this.poll),this.connection.send(o)}},l.prototype._dataToDocs=function(t){for(var e,n=[],i=0;i<t.length;i++){var o=t[i];o.type?e=o.type:o.type=e;var r=this.connection.get(o.c||this.collection,o.d,o);"sub"===this.docMode&&r._finishQuerySubscribe(o.v),n.push(r)}return n},l.prototype.destroy=function(){this.connection.canSend&&"sub"===this.type&&this.connection.send({a:"qunsub",id:this.id}),this.connection._destroyQuery(this)},l.prototype._onConnectionStateChanged=function(){"connecting"===this.connection.state&&this._execute()},l.prototype._onMessage=function(t){if("qfetch"===t.a!=("fetch"===this.type))return void(console&&console.warn("Invalid message sent to query",t,this));switch(t.error&&this.emit("error",t.error),t.a){case"qfetch":var e=t.data?this._dataToDocs(t.data):void 0;this.callback&&this.callback(t.error,e,t.extra),this.connection._destroyQuery(this);break;case"q":if(t.diff){for(var n=0;n<t.diff.length;n++){var i=t.diff[n];"insert"===i.type&&(i.values=this._dataToDocs(i.values))}for(var n=0;n<t.diff.length;n++){var i=t.diff[n];switch(i.type){case"insert":var o=i.values;Array.prototype.splice.apply(this.results,[i.index,0].concat(o)),this.emit("insert",o,i.index);break;case"remove":var r=i.howMany||1,s=this.results.splice(i.index,r);this.emit("remove",s,i.index);break;case"move":var r=i.howMany||1,a=this.results.splice(i.from,r);Array.prototype.splice.apply(this.results,[i.to,0].concat(a)),this.emit("move",a,i.from,i.to)}}}void 0!==t.extra&&this.emit("extra",t.extra);break;case"qsub":if(!t.error){var c=this.results;this.results=this.knownDocs=this._dataToDocs(t.data),this.extra=t.extra,this.ready=!0,this.emit("change",this.results,c)}this.callback&&(this.callback(t.error,this.results,this.extra),delete this.callback)}},l.prototype.setQuery=function(t){if("sub"!==this.type)throw Error("cannot change a fetch query");this.query=t,this.connection.canSend&&(this.connection.send({a:"qunsub",id:this.id}),this._execute())};var i;"undefined"!=typeof require&&(i=require("./microevent")),i.mixin(l)}();