<!doctype html>
<html>
  <head>
    <title>Ace Editor - ShareJS and RethinkDB</title>
    <meta charset="utf-8">
    <link href='/lib/codemirror/lib/codemirror.css' rel='stylesheet'>
    <link href='/lib/codemirror/theme/solarized.css' rel='stylesheet'>
  </head>
  <body>
    <textarea id="editor"></textarea>
    <script src="/lib/json0.js"></script>
    <script src="/lib/text.js"></script>
    <script src="/lib/share.uncompressed.js"></script>
    <script src="/lib/codemirror/lib/codemirror.js"></script>
    <script src="/lib/codemirror/addon/edit/matchbrackets.js"></script>
    <script src="/lib/codemirror/mode/meta.js"></script>
    <script src="/lib/codemirror/mode/javascript/javascript.js"></script>
    <script src="/share-codemirror.js"></script>
    <script>
    // Editor
    var elem = document.getElementById('editor');
    var m = CodeMirror.findModeByName('js');
    var cm = CodeMirror.fromTextArea(elem, {
      mode: 'javascript',
      lineNumbers: true,
      matchBrackets: true,
      theme: 'solarized dark'
    });

    // ShareJS
    var ws = new WebSocket('ws://localhost:8005');
    var sjs = new window.sharejs.Connection(ws);
    var doc = sjs.get('documents', 'sharejs_example');
    doc.subscribe();
    doc.whenReady(function () {
        /**
         * For some reason, doc.type comes out as undefined, even though it's
         * there if we console.log the whole object or console.log the keys
         *
         * In order to fix this, we just have a setTimeout
         */
        setTimeout(function () {
            if (!doc.type) {
              doc.create('text');
            }
            if (doc.type && doc.type.name === 'text') {
              doc.attachCodeMirror(cm);
            }
        });
    });  
    </script>
  </body>
</html>
